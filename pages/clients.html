<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Клиенты - ЧИП: Система управления сервисным центром</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/dashboard.css">
    <link rel="stylesheet" href="../css/responsive.css">
    <style>
        .clients-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-xl);
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }
        
        .clients-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }
         .modal-header {
            background: var(--color-bg-card);
        }
        .modal-footer {
            background: var(--color-bg-card);
        }
        .stat-card {
            background: var(--color-bg-card);
            
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-md);
            border-left: 4px solid var(--color-primary);
        }
        
        .stat-card.success {
            border-left-color: var(--color-success);
        }
        
        .stat-card.warning {
            border-left-color: var(--color-warning);
        }
        
        .stat-card.info {
            border-left-color: var(--color-info);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--color-text);
            margin-bottom: var(--spacing-xs);
        }
        
        .stat-label {
            color: var(--color-text-light);
            font-size: var(--font-size-sm);
        }
        
        .client-badge {
            padding: 4px 10px;
            border-radius: var(--radius-sm);
            font-size: var(--font-size-xs);
            font-weight: 500;
        }
        
        .badge-regular {
            background-color: rgba(59, 130, 246, 0.1);
            color: var(--color-primary);
        }
        
        .badge-vip {
            background-color: rgba(245, 158, 11, 0.1);
            color: var(--color-warning);
        }
        
        .badge-corporate {
            background-color: rgba(139, 92, 246, 0.1);
            color: #8B5CF6;
        }
        
        .search-filter {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            flex-wrap: wrap;
        }
        
        .search-box {
            flex: 1;
            min-width: 300px;
        }
        
        .filter-btn {
            padding: var(--spacing-sm) var(--spacing-lg);
            background-color: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-family: var(--font-family);
            font-size: var(--font-size-sm);
            color: var(--color-text-light);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .filter-btn:hover {
            background-color: var(--color-bg-hover);
            color: var(--color-text);
        }
        
        .filter-btn.active {
            background-color: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }
        
        .client-actions {
            display: flex;
            gap: var(--spacing-xs);
        }
        
        .client-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--color-primary-light);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: var(--font-size-lg);
        }
        
        .client-row {
            cursor: pointer;
            transition: background-color var(--transition-fast);
        }
        
        .client-row:hover {
            background-color: var(--color-bg-hover);
        }
        
        .empty-clients {
            text-align: center;
            padding: var(--spacing-2xl) var(--spacing-lg);
        }
        
        .empty-clients-icon {
            font-size: 48px;
            color: var(--color-text-lighter);
            margin-bottom: var(--spacing-lg);
        }
        
        .empty-clients-title {
            font-size: var(--font-size-xl);
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
            color: var(--color-text);
        }
        
        .client-tags {
            display: flex;
            gap: var(--spacing-xs);
            flex-wrap: wrap;
            margin-top: var(--spacing-xs);
        }
        
        .tag {
            padding: 2px 8px;
            background-color: var(--color-bg);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-xs);
            color: var(--color-text-light);
        }
        
        .client-details-link {
            color: var(--color-primary);
            text-decoration: none;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            transition: color var(--transition-fast);
        }
        
        .client-details-link:hover {
            color: var(--color-primary-dark);
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Боковая панель навигации -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">Ч</div>
                <div>
                    <div class="logo-text">ЧИП: ServiceTrack</div>
                    <div class="logo-subtext">Управление сервисным центром</div>
                </div>
            </div>
            
            <nav class="nav-menu">
                <a href="../index.html" class="nav-item">
                    <i class="fas fa-home"></i>
                    <span>Дашборд</span>
                </a>
                <a href="orders.html" class="nav-item">
                    <i class="fas fa-clipboard-list"></i>
                    <span>Заявки</span>
                </a>
                <a href="clients.html" class="nav-item active">
                    <i class="fas fa-users"></i>
                    <span>Клиенты</span>
                </a>
                <a href="employees.html" class="nav-item">
                    <i class="fas fa-user-cog"></i>
                    <span>Мастера</span>
                </a>
                <a href="services.html" class="nav-item">
                    <i class="fas fa-cogs"></i>
                    <span>Услуги и запчасти</span>
                </a>
                <a href="reports.html" class="nav-item">
                    <i class="fas fa-chart-bar"></i>
                    <span>Отчёты</span>
                </a>
                <a href="settings.html" class="nav-item">
                    <i class="fas fa-cog"></i>
                    <span>Настройки</span>
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <div class="user-avatar">ИП</div>
                <div class="user-info">
                    <div class="user-name">Иван Петров</div>
                    <div class="user-role">Администратор</div>
                </div>
            </div>
        </aside>
        
        <!-- Основное содержимое -->
        <main class="main-content">
            <!-- Верхняя панель -->
            <header class="topbar">
                <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                    <button class="mobile-menu-toggle" id="menuToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="page-title">Клиенты</h1>
                </div>
                
                <div class="topbar-actions">
                    <button class="btn btn-secondary" id="exportClientsBtn">
                        <i class="fas fa-download"></i>
                        Экспорт
                    </button>
                    <button class="btn btn-primary" id="addClientBtn">
                        <i class="fas fa-user-plus"></i>
                        Добавить клиента
                    </button>
                </div>
            </header>
            
            <!-- Статистика -->
            <div class="clients-stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalClients">0</div>
                    <div class="stat-label">Всего клиентов</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-value" id="activeClients">0</div>
                    <div class="stat-label">Активные клиенты</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-value" id="totalOrders">0</div>
                    <div class="stat-label">Всего заказов</div>
                </div>
                <div class="stat-card info">
                    <div class="stat-value" id="avgOrders">0</div>
                    <div class="stat-label">Среднее на клиента</div>
                </div>
            </div>
            
            <!-- Поиск и фильтры -->
            <div class="search-filter">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="clientsSearch" placeholder="Поиск клиентов...">
                </div>
                
                <div style="display: flex; gap: var(--spacing-sm); flex-wrap: wrap;">
                    <button class="filter-btn active" data-filter="all">
                        <i class="fas fa-users"></i>
                        Все клиенты
                    </button>
                    <button class="filter-btn" data-filter="regular">
                        <i class="fas fa-user"></i>
                        Обычные
                    </button>
                    <button class="filter-btn" data-filter="vip">
                        <i class="fas fa-crown"></i>
                        VIP
                    </button>
                    <button class="filter-btn" data-filter="corporate">
                        <i class="fas fa-building"></i>
                        Корпоративные
                    </button>
                </div>
                
                <select class="form-control" id="sortBy" style="width: 200px;">
                    <option value="name_asc">По имени (А-Я)</option>
                    <option value="name_desc">По имени (Я-А)</option>
                    <option value="orders_desc">По заказам (убыв.)</option>
                    <option value="orders_asc">По заказам (возр.)</option>
                    <option value="last_order_desc">По дате (новые)</option>
                    <option value="last_order_asc">По дате (старые)</option>
                </select>
            </div>
            
            <!-- Таблица клиентов -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Список клиентов</h3>
                    <div class="card-actions">
                        <button class="btn btn-sm btn-secondary" id="importClientsBtn">
                            <i class="fas fa-upload"></i>
                            Импорт
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th style="width: 60px;"></th>
                                    <th>Клиент</th>
                                    <th>Контакты</th>
                                    <th>Статус</th>
                                    <th>Заказы</th>
                                    <th>Последний заказ</th>
                                    <th>Общая сумма</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="clientsTableBody">
                                <!-- Клиенты загружаются через JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Состояние "нет клиентов" -->
                    <div class="empty-clients d-none" id="emptyClients">
                        <div class="empty-clients-icon">
                            <i class="fas fa-user-friends"></i>
                        </div>
                        <h3 class="empty-clients-title">Клиенты не найдены</h3>
                        <p class="mb-4">Добавьте первого клиента или измените параметры поиска</p>
                        <button class="btn btn-primary" id="addFirstClientBtn">
                            <i class="fas fa-user-plus"></i>
                            Добавить клиента
                        </button>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="text-muted small" id="clientsInfo">
                            Показано 0 из 0 клиентов
                        </div>
                        <div class="pagination" id="clientsPagination">
                            <!-- Пагинация загружается через JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Модальное окно добавления клиента -->
    <div class="modal" id="addClientModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Добавление клиента</h3>
                <button class="modal-close" data-modal="addClientModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="addClientForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Фамилия <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="lastName" required 
                                       placeholder="Иванов">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Имя <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="firstName" required 
                                       placeholder="Иван">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Отчество</label>
                        <input type="text" class="form-control" name="middleName" 
                               placeholder="Иванович">
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Телефон <span class="text-danger">*</span></label>
                                <input type="tel" class="form-control" name="phone" required 
                                       placeholder="+7 (999) 123-45-67">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" name="email" 
                                       placeholder="client@example.com">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Дата рождения</label>
                        <input type="date" class="form-control" name="birthDate">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Статус клиента</label>
                        <select class="form-control" name="status" required>
                            <option value="regular">Обычный</option>
                            <option value="vip">VIP</option>
                            <option value="corporate">Корпоративный</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Компания</label>
                        <input type="text" class="form-control" name="company" 
                               placeholder="Название компании">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Должность</label>
                        <input type="text" class="form-control" name="position" 
                               placeholder="Должность">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Адрес</label>
                        <textarea class="form-control" name="address" rows="2" 
                                  placeholder="Адрес проживания"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Примечания</label>
                        <textarea class="form-control" name="notes" rows="3" 
                                  placeholder="Дополнительная информация"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Теги</label>
                        <input type="text" class="form-control" name="tags" 
                               placeholder="Введите теги через запятую">
                        <small class="text-muted">Например: постоянный клиент, ноутбуки, студент</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="checkbox">
                            <input type="checkbox" name="newsletter" checked>
                            <span class="checkbox-text">Подписан на рассылку</span>
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-modal="addClientModal">Отмена</button>
                <button type="submit" form="addClientForm" class="btn btn-primary">Добавить клиента</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно просмотра клиента -->
    <div class="modal" id="viewClientModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title">Информация о клиенте</h3>
                <button class="modal-close" data-modal="viewClientModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="clientDetails">
                    <!-- Информация загружается через JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-modal="viewClientModal">Закрыть</button>
                <button type="button" class="btn btn-primary" id="editClientFromViewBtn">Редактировать</button>
            </div>
        </div>
    </div>

    <script src="../js/main.js"></script>
    <script>
        // Система управления клиентами
        class ClientsSystem {
            constructor() {
                this.clients = this.loadClients();
                this.storageKey = 'chip_clients';
                this.currentPage = 1;
                this.itemsPerPage = 10;
            }
            
            loadClients() {
                const saved = localStorage.getItem(this.storageKey);
                if (saved) return JSON.parse(saved);
                
                // Демо-клиенты
                const demoClients = [
                    {
                        id: 1,
                        firstName: "Александр",
                        lastName: "Иванов",
                        middleName: "Петрович",
                        fullName: "Иванов Александр Петрович",
                        phone: "+7 (999) 111-22-33",
                        email: "a.ivanov@mail.ru",
                        birthDate: "1985-05-15",
                        status: "regular",
                        company: "ООО 'ТехноСервис'",
                        position: "Директор",
                        address: "г. Москва, ул. Ленина, д. 15, кв. 42",
                        notes: "Постоянный клиент, предпочитает ремонт ноутбуков",
                        tags: ["постоянный", "ноутбуки", "бизнес"],
                        orders: 5,
                        totalSpent: 18500,
                        lastOrder: "2025-12-24",
                        createdAt: "2024-01-15",
                        newsletter: true,
                        isActive: true
                    },
                    {
                        id: 2,
                        firstName: "Мария",
                        lastName: "Смирнова",
                        middleName: "Ивановна",
                        fullName: "Смирнова Мария Ивановна",
                        phone: "+7 (999) 222-33-44",
                        email: "m.smirnova@gmail.com",
                        birthDate: "1992-08-23",
                        status: "vip",
                        company: "",
                        position: "Фрилансер",
                        address: "г. Москва, ул. Пушкина, д. 8, кв. 12",
                        notes: "VIP клиент, всегда заказывает быстрый ремонт",
                        tags: ["vip", "срочный ремонт", "смартфоны"],
                        orders: 12,
                        totalSpent: 42500,
                        lastOrder: "2025-12-20",
                        createdAt: "2023-11-30",
                        newsletter: true,
                        isActive: true
                    },
                    {
                        id: 3,
                        firstName: "Дмитрий",
                        lastName: "Кузнецов",
                        middleName: "Сергеевич",
                        fullName: "Кузнецов Дмитрий Сергеевич",
                        phone: "+7 (999) 333-44-55",
                        email: "d.kuznetsov@company.ru",
                        birthDate: "1978-11-03",
                        status: "corporate",
                        company: "ИТ-Компания 'Прогресс'",
                        position: "IT-менеджер",
                        address: "г. Москва, пр. Мира, д. 25, офис 304",
                        notes: "Корпоративный клиент, обслуживает офисную технику",
                        tags: ["корпоративный", "оргтехника", "сервисный контракт"],
                        orders: 8,
                        totalSpent: 31500,
                        lastOrder: "2025-12-22",
                        createdAt: "2024-02-10",
                        newsletter: false,
                        isActive: true
                    },
                    {
                        id: 4,
                        firstName: "Елена",
                        lastName: "Петрова",
                        middleName: "Владимировна",
                        fullName: "Петрова Елена Владимировна",
                        phone: "+7 (999) 444-55-66",
                        email: "elena.petrova@yandex.ru",
                        birthDate: "1995-03-17",
                        status: "regular",
                        company: "",
                        position: "Студент",
                        address: "г. Москва, ул. Студенческая, д. 3, кв. 7",
                        notes: "Студент, часто ремонтирует ноутбук",
                        tags: ["студент", "ноутбук", "бюджетный ремонт"],
                        orders: 3,
                        totalSpent: 8500,
                        lastOrder: "2025-12-18",
                        createdAt: "2024-03-05",
                        newsletter: true,
                        isActive: true
                    },
                    {
                        id: 5,
                        firstName: "Андрей",
                        lastName: "Соколов",
                        middleName: "Александрович",
                        fullName: "Соколов Андрей Александрович",
                        phone: "+7 (999) 555-66-77",
                        email: "andrey.sokolov@mail.ru",
                        birthDate: "1980-12-08",
                        status: "vip",
                        company: "Фриланс",
                        position: "Разработчик",
                        address: "г. Москва, ул. Программистов, д. 7, кв. 33",
                        notes: "Разработчик, много техники, VIP статус за количество заказов",
                        tags: ["vip", "программист", "много заказов"],
                        orders: 15,
                        totalSpent: 57800,
                        lastOrder: "2025-12-23",
                        createdAt: "2023-09-12",
                        newsletter: true,
                        isActive: true
                    }
                ];
                
                this.saveClients(demoClients);
                return demoClients;
            }
            
            saveClients(clients) {
                localStorage.setItem(this.storageKey, JSON.stringify(clients));
            }
            
            getClients(filter = {}) {
                let filtered = [...this.clients];
                
                if (filter.status && filter.status !== 'all') {
                    filtered = filtered.filter(c => c.status === filter.status);
                }
                
                if (filter.search) {
                    const searchTerm = filter.search.toLowerCase();
                    filtered = filtered.filter(c => 
                        c.fullName.toLowerCase().includes(searchTerm) ||
                        c.phone.toLowerCase().includes(searchTerm) ||
                        c.email?.toLowerCase().includes(searchTerm) ||
                        c.company?.toLowerCase().includes(searchTerm)
                    );
                }
                
                if (filter.activeOnly) {
                    filtered = filtered.filter(c => c.isActive);
                }
                
                // Сортировка
                if (filter.sortBy) {
                    filtered.sort((a, b) => {
                        switch(filter.sortBy) {
                            case 'name_asc':
                                return a.fullName.localeCompare(b.fullName);
                            case 'name_desc':
                                return b.fullName.localeCompare(a.fullName);
                            case 'orders_desc':
                                return b.orders - a.orders;
                            case 'orders_asc':
                                return a.orders - b.orders;
                            case 'last_order_desc':
                                return new Date(b.lastOrder) - new Date(a.lastOrder);
                            case 'last_order_asc':
                                return new Date(a.lastOrder) - new Date(b.lastOrder);
                            default:
                                return 0;
                        }
                    });
                }
                
                return filtered;
            }
            
            getPaginatedClients(filter = {}, page = 1) {
                const filtered = this.getClients(filter);
                const total = filtered.length;
                const pages = Math.ceil(total / this.itemsPerPage);
                const start = (page - 1) * this.itemsPerPage;
                const end = start + this.itemsPerPage;
                
                return {
                    clients: filtered.slice(start, end),
                    total,
                    pages,
                    currentPage: page
                };
            }
            
            addClient(clientData) {
                const fullName = `${clientData.lastName} ${clientData.firstName} ${clientData.middleName || ''}`.trim();
                
                const newClient = {
                    id: this.clients.length > 0 ? Math.max(...this.clients.map(c => c.id)) + 1 : 1,
                    ...clientData,
                    fullName,
                    orders: 0,
                    totalSpent: 0,
                    lastOrder: null,
                    createdAt: new Date().toISOString(),
                    isActive: true
                };
                
                this.clients.push(newClient);
                this.saveClients(this.clients);
                
                return {
                    success: true,
                    client: newClient
                };
            }
            
            updateClient(clientId, clientData) {
                const index = this.clients.findIndex(c => c.id === clientId);
                if (index === -1) {
                    return {
                        success: false,
                        message: 'Клиент не найден'
                    };
                }
                
                if (clientData.lastName || clientData.firstName || clientData.middleName) {
                    const lastName = clientData.lastName || this.clients[index].lastName;
                    const firstName = clientData.firstName || this.clients[index].firstName;
                    const middleName = clientData.middleName || this.clients[index].middleName;
                    clientData.fullName = `${lastName} ${firstName} ${middleName || ''}`.trim();
                }
                
                this.clients[index] = {
                    ...this.clients[index],
                    ...clientData
                };
                
                this.saveClients(this.clients);
                
                return {
                    success: true,
                    client: this.clients[index]
                };
            }
            
            deleteClient(clientId) {
                const index = this.clients.findIndex(c => c.id === clientId);
                if (index === -1) {
                    return {
                        success: false,
                        message: 'Клиент не найден'
                    };
                }
                
                // Не удаляем, а делаем неактивным
                this.clients[index].isActive = false;
                this.saveClients(this.clients);
                
                return {
                    success: true,
                    message: 'Клиент отключен'
                };
            }
            
            getClientStats() {
                const activeClients = this.clients.filter(c => c.isActive).length;
                const totalClients = this.clients.length;
                const totalOrders = this.clients.reduce((sum, client) => sum + client.orders, 0);
                const avgOrders = totalClients > 0 ? (totalOrders / totalClients).toFixed(1) : 0;
                
                const statusCounts = {
                    regular: this.clients.filter(c => c.status === 'regular').length,
                    vip: this.clients.filter(c => c.status === 'vip').length,
                    corporate: this.clients.filter(c => c.status === 'corporate').length
                };
                
                return {
                    totalClients,
                    activeClients,
                    totalOrders,
                    avgOrders,
                    statusCounts
                };
            }
        }
        
        // Создаем глобальный экземпляр системы
        window.Clients = new ClientsSystem();
        
        // Инициализация страницы
        document.addEventListener('DOMContentLoaded', function() {
            initClientsPage();
        });
        
        function initClientsPage() {
            // Кнопки добавления
            document.getElementById('addClientBtn')?.addEventListener('click', function() {
                openModal('addClientModal');
                loadClientForm();
            });
            
            document.getElementById('addFirstClientBtn')?.addEventListener('click', function() {
                openModal('addClientModal');
                loadClientForm();
            });
            
            document.getElementById('exportClientsBtn')?.addEventListener('click', exportClients);
            document.getElementById('importClientsBtn')?.addEventListener('click', importClients);
            document.getElementById('editClientFromViewBtn')?.addEventListener('click', editClientFromView);
            
            // Формы
            document.getElementById('addClientForm')?.addEventListener('submit', handleAddClient);
            
            // Поиск
            const searchInput = document.getElementById('clientsSearch');
            if (searchInput) {
                searchInput.addEventListener('input', debounce(performSearch, 300));
            }
            
            // Фильтры
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    applyFilters();
                });
            });
            
            // Сортировка
            const sortSelect = document.getElementById('sortBy');
            if (sortSelect) {
                sortSelect.addEventListener('change', function() {
                    applyFilters();
                });
            }
            
            // Пагинация
            document.addEventListener('click', function(e) {
                if (e.target.closest('.page-link')) {
                    e.preventDefault();
                    const page = parseInt(e.target.closest('.page-link').dataset.page);
                    if (page) {
                        loadClientsTable(page);
                    }
                }
            });
            
            // Загрузка начальных данных
            loadClientStats();
            loadClientsTable();
        }
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        function loadClientStats() {
            const stats = Clients.getClientStats();
            
            document.getElementById('totalClients').textContent = stats.totalClients;
            document.getElementById('activeClients').textContent = stats.activeClients;
            document.getElementById('totalOrders').textContent = stats.totalOrders;
            document.getElementById('avgOrders').textContent = stats.avgOrders;
        }
        
        function loadClientsTable(page = 1) {
            const tbody = document.getElementById('clientsTableBody');
            const emptyState = document.getElementById('emptyClients');
            const clientsInfo = document.getElementById('clientsInfo');
            const pagination = document.getElementById('clientsPagination');
            
            if (!tbody || !emptyState || !clientsInfo || !pagination) return;
            
            const filters = getCurrentFilters();
            const result = Clients.getPaginatedClients(filters, page);
            
            // Обновляем статистику
            loadClientStats();
            
            if (result.total === 0) {
                tbody.innerHTML = '';
                emptyState.classList.remove('d-none');
                clientsInfo.textContent = 'Показано 0 из 0 клиентов';
                pagination.innerHTML = '';
                return;
            }
            
            emptyState.classList.add('d-none');
            
            // Генерируем строки таблицы
            tbody.innerHTML = result.clients.map(client => {
                const statusClass = `badge-${client.status}`;
                const statusText = getStatusText(client.status);
                const lastOrder = client.lastOrder ? new Date(client.lastOrder).toLocaleDateString('ru-RU') : '—';
                const initials = getInitials(client.firstName, client.lastName);
                const avatarColor = getAvatarColor(client.id);
                
                return `
                <tr class="client-row" data-client-id="${client.id}">
                    <td>
                        <div class="client-avatar" style="background-color: ${avatarColor}">
                            ${initials}
                        </div>
                    </td>
                    <td>
                        <div class="font-weight-medium">${client.fullName}</div>
                        ${client.company ? `<div class="text-muted small">${client.company}</div>` : ''}
                        <div class="client-tags">
                            ${client.tags?.map(tag => `<span class="tag">${tag}</span>`).join('') || ''}
                        </div>
                    </td>
                    <td>
                        <div>${client.phone}</div>
                        ${client.email ? `<div class="text-muted small">${client.email}</div>` : ''}
                    </td>
                    <td>
                        <span class="client-badge ${statusClass}">${statusText}</span>
                    </td>
                    <td>
                        <div class="text-center">
                            <div class="font-weight-medium">${client.orders}</div>
                            <div class="text-muted small">${client.totalSpent.toLocaleString('ru-RU')} ₽</div>
                        </div>
                    </td>
                    <td>${lastOrder}</td>
                    <td>
                        <div class="font-weight-medium">${client.totalSpent.toLocaleString('ru-RU')} ₽</div>
                    </td>
                    <td>
                        <div class="client-actions">
                            <button class="action-btn view" data-client-id="${client.id}" title="Просмотр">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn edit" data-client-id="${client.id}" title="Редактировать">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete" data-client-id="${client.id}" title="Удалить">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `}).join('');
            
            // Информация о клиентах
            const start = (result.currentPage - 1) * Clients.itemsPerPage + 1;
            const end = Math.min(start + Clients.itemsPerPage - 1, result.total);
            clientsInfo.textContent = `Показано ${start}-${end} из ${result.total} клиентов`;
            
            // Пагинация
            pagination.innerHTML = generatePagination(result.currentPage, result.pages);
            
            // Обработчики для строк таблицы
            tbody.querySelectorAll('.client-row').forEach(row => {
                row.addEventListener('click', function(e) {
                    if (!e.target.closest('.action-btn')) {
                        const clientId = parseInt(this.getAttribute('data-client-id'));
                        viewClient(clientId);
                    }
                });
            });
            
            // Обработчики для кнопок действий
            tbody.querySelectorAll('.action-btn.view').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const clientId = parseInt(this.getAttribute('data-client-id'));
                    viewClient(clientId);
                });
            });
            
            tbody.querySelectorAll('.action-btn.edit').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const clientId = parseInt(this.getAttribute('data-client-id'));
                    editClient(clientId);
                });
            });
            
            tbody.querySelectorAll('.action-btn.delete').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const clientId = parseInt(this.getAttribute('data-client-id'));
                    deleteClient(clientId);
                });
            });
        }
        
        function getCurrentFilters() {
            const filters = {};
            
            // Активный фильтр
            const activeFilter = document.querySelector('.filter-btn.active');
            if (activeFilter) {
                filters.status = activeFilter.getAttribute('data-filter');
            }
            
            // Поиск
            const searchInput = document.getElementById('clientsSearch');
            if (searchInput && searchInput.value.trim()) {
                filters.search = searchInput.value.trim();
            }
            
            // Сортировка
            const sortSelect = document.getElementById('sortBy');
            if (sortSelect) {
                filters.sortBy = sortSelect.value;
            }
            
            filters.activeOnly = true;
            
            return filters;
        }
        
        function performSearch() {
            applyFilters();
        }
        
        function applyFilters() {
            loadClientsTable(1);
        }
        
        function loadClientForm() {
            const form = document.getElementById('addClientForm');
            if (!form) return;
            
            // Сброс формы
            form.reset();
            
            // Устанавливаем сегодняшнюю дату как минимальную для даты рождения
            const birthDateInput = form.querySelector('[name="birthDate"]');
            if (birthDateInput) {
                const today = new Date().toISOString().split('T')[0];
                birthDateInput.max = today;
            }
            
            // Устанавливаем заголовок по умолчанию
            const modalTitle = document.querySelector('#addClientModal .modal-title');
            if (modalTitle) modalTitle.textContent = 'Добавление клиента';
            
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) submitBtn.textContent = 'Добавить клиента';
        }
        
        function handleAddClient(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            
            const clientData = {
                firstName: formData.get('firstName'),
                lastName: formData.get('lastName'),
                middleName: formData.get('middleName'),
                phone: formData.get('phone'),
                email: formData.get('email'),
                birthDate: formData.get('birthDate') || null,
                status: formData.get('status'),
                company: formData.get('company') || '',
                position: formData.get('position') || '',
                address: formData.get('address') || '',
                notes: formData.get('notes') || '',
                tags: formData.get('tags') ? formData.get('tags').split(',').map(tag => tag.trim()).filter(tag => tag) : [],
                newsletter: formData.get('newsletter') === 'on'
            };
            
            const result = Clients.addClient(clientData);
            
            if (result.success) {
                showNotification('Клиент успешно добавлен!', 'success');
                closeModal('addClientModal');
                loadClientsTable();
                loadClientStats();
            } else {
                showNotification('Ошибка при добавлении клиента', 'error');
            }
        }
        
        function viewClient(clientId) {
            const client = Clients.clients.find(c => c.id === clientId);
            if (!client) return;
            
            const modalContent = document.getElementById('clientDetails');
            if (!modalContent) return;
            
            const lastOrder = client.lastOrder ? new Date(client.lastOrder).toLocaleDateString('ru-RU') : 'Нет заказов';
            const createdAt = new Date(client.createdAt).toLocaleDateString('ru-RU');
            const birthDate = client.birthDate ? new Date(client.birthDate).toLocaleDateString('ru-RU') : 'Не указана';
            const statusText = getStatusText(client.status);
            
            modalContent.innerHTML = `
                <div class="row mb-4">
                    <div class="col-md-3 text-center">
                        <div class="client-avatar" style="width: 80px; height: 80px; font-size: 32px; margin: 0 auto 15px; background-color: ${getAvatarColor(client.id)}">
                            ${getInitials(client.firstName, client.lastName)}
                        </div>
                        <h4>${client.fullName}</h4>
                        <span class="client-badge badge-${client.status}">${statusText}</span>
                    </div>
                    <div class="col-md-9">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="text-muted small">Телефон</label>
                                    <div class="font-weight-medium">${client.phone}</div>
                                </div>
                                <div class="mb-3">
                                    <label class="text-muted small">Email</label>
                                    <div class="font-weight-medium">${client.email || 'Не указан'}</div>
                                </div>
                                <div class="mb-3">
                                    <label class="text-muted small">Дата рождения</label>
                                    <div class="font-weight-medium">${birthDate}</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="text-muted small">Компания</label>
                                    <div class="font-weight-medium">${client.company || 'Не указана'}</div>
                                </div>
                                <div class="mb-3">
                                    <label class="text-muted small">Должность</label>
                                    <div class="font-weight-medium">${client.position || 'Не указана'}</div>
                                </div>
                                <div class="mb-3">
                                    <label class="text-muted small">Дата регистрации</label>
                                    <div class="font-weight-medium">${createdAt}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Статистика заказов</h5>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-6">
                                        <div class="stat-value" style="font-size: 1.5rem;">${client.orders}</div>
                                        <div class="stat-label">Всего заказов</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="stat-value" style="font-size: 1.5rem;">${client.totalSpent.toLocaleString('ru-RU')} ₽</div>
                                        <div class="stat-label">Общая сумма</div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <div class="text-muted small mb-1">Последний заказ</div>
                                    <div class="font-weight-medium">${lastOrder}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Дополнительно</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <label class="text-muted small">Подписка на рассылку</label>
                                    <div class="font-weight-medium">${client.newsletter ? 'Подписан' : 'Не подписан'}</div>
                                </div>
                                <div class="mb-2">
                                    <label class="text-muted small">Теги</label>
                                    <div class="client-tags">
                                        ${client.tags?.map(tag => `<span class="tag">${tag}</span>`).join('') || 'Нет тегов'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Адрес и примечания</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="text-muted small">Адрес</label>
                            <div class="font-weight-medium">${client.address || 'Не указан'}</div>
                        </div>
                        <div>
                            <label class="text-muted small">Примечания</label>
                            <div>${client.notes || 'Нет примечаний'}</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Сохраняем ID клиента для кнопки редактирования
            const editBtn = document.getElementById('editClientFromViewBtn');
            if (editBtn) {
                editBtn.dataset.clientId = clientId;
            }
            
            openModal('viewClientModal');
        }
        
        function editClientFromView() {
            const clientId = this.dataset.clientId;
            if (clientId) {
                closeModal('viewClientModal');
                editClient(parseInt(clientId));
            }
        }
        
        function editClient(clientId) {
            const client = Clients.clients.find(c => c.id === clientId);
            if (!client) return;
            
            openModal('addClientModal');
            
            const form = document.getElementById('addClientForm');
            if (form) {
                form.querySelector('[name="firstName"]').value = client.firstName;
                form.querySelector('[name="lastName"]').value = client.lastName;
                form.querySelector('[name="middleName"]').value = client.middleName || '';
                form.querySelector('[name="phone"]').value = client.phone;
                form.querySelector('[name="email"]').value = client.email || '';
                form.querySelector('[name="birthDate"]').value = client.birthDate || '';
                form.querySelector('[name="status"]').value = client.status;
                form.querySelector('[name="company"]').value = client.company || '';
                form.querySelector('[name="position"]').value = client.position || '';
                form.querySelector('[name="address"]').value = client.address || '';
                form.querySelector('[name="notes"]').value = client.notes || '';
                form.querySelector('[name="tags"]').value = client.tags?.join(', ') || '';
                form.querySelector('[name="newsletter"]').checked = client.newsletter;
                
                // Изменяем заголовок и действие формы
                const modalTitle = document.querySelector('#addClientModal .modal-title');
                if (modalTitle) modalTitle.textContent = 'Редактирование клиента';
                
                const submitBtn = form.querySelector('button[type="submit"]');
                if (submitBtn) submitBtn.textContent = 'Сохранить изменения';
                
                // Удаляем старый обработчик и добавляем новый
                form.removeEventListener('submit', handleAddClient);
                form.addEventListener('submit', function(event) {
                    event.preventDefault();
                    
                    const formData = new FormData(form);
                    
                    const updatedData = {
                        firstName: formData.get('firstName'),
                        lastName: formData.get('lastName'),
                        middleName: formData.get('middleName'),
                        phone: formData.get('phone'),
                        email: formData.get('email'),
                        birthDate: formData.get('birthDate') || null,
                        status: formData.get('status'),
                        company: formData.get('company') || '',
                        position: formData.get('position') || '',
                        address: formData.get('address') || '',
                        notes: formData.get('notes') || '',
                        tags: formData.get('tags') ? formData.get('tags').split(',').map(tag => tag.trim()).filter(tag => tag) : [],
                        newsletter: formData.get('newsletter') === 'on'
                    };
                    
                    const result = Clients.updateClient(clientId, updatedData);
                    
                    if (result.success) {
                        showNotification('Клиент успешно обновлен!', 'success');
                        closeModal('addClientModal');
                        loadClientsTable();
                        loadClientStats();
                    } else {
                        showNotification('Ошибка при обновлении клиента', 'error');
                    }
                });
            }
        }
        
        function deleteClient(clientId) {
            if (confirm('Вы уверены, что хотите отключить этого клиента? Клиент будет помечен как неактивный.')) {
                const result = Clients.deleteClient(clientId);
                
                if (result.success) {
                    showNotification('Клиент отключен', 'success');
                    loadClientsTable();
                    loadClientStats();
                } else {
                    showNotification('Ошибка при отключении клиента', 'error');
                }
            }
        }
        
        function exportClients() {
            const clients = Clients.getClients({ activeOnly: true });
            
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Заголовок
            csvContent += "ФИО,Телефон,Email,Статус,Компания,Должность,Заказов,Общая сумма,Последний заказ,Адрес\n";
            
            // Данные
            clients.forEach(client => {
                const statusText = getStatusText(client.status);
                const lastOrder = client.lastOrder ? new Date(client.lastOrder).toLocaleDateString('ru-RU') : '';
                csvContent += `${client.fullName},${client.phone},${client.email || ''},${statusText},${client.company || ''},${client.position || ''},${client.orders},${client.totalSpent},${lastOrder},${client.address || ''}\n`;
            });
            
            // Создаем ссылку для скачивания
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `clients-${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('Клиенты экспортированы', 'success');
        }
        
        function importClients() {
            // Простая реализация импорта
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv';
            
            input.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const csvContent = e.target.result;
                        // Здесь можно добавить парсинг CSV
                        showNotification('Функция импорта в разработке', 'info');
                    } catch (error) {
                        showNotification('Ошибка при чтении файла', 'error');
                    }
                };
                reader.readAsText(file);
            });
            
            input.click();
        }
        
        // Вспомогательные функции
        function getStatusText(status) {
            const statuses = {
                'regular': 'Обычный',
                'vip': 'VIP',
                'corporate': 'Корпоративный'
            };
            return statuses[status] || status;
        }
        
        function getInitials(firstName, lastName) {
            return `${firstName.charAt(0)}${lastName.charAt(0)}`.toUpperCase();
        }
        
        function getAvatarColor(id) {
            const colors = [
                '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6',
                '#EC4899', '#06B6D4', '#84CC16', '#F97316', '#6366F1'
            ];
            return colors[id % colors.length];
        }
        
        function generatePagination(currentPage, totalPages) {
            if (totalPages <= 1) return '';
            
            let html = '<ul class="pagination-list">';
            
            // Кнопка "Назад"
            if (currentPage > 1) {
                html += `<li><a href="#" class="page-link" data-page="${currentPage - 1}"><i class="fas fa-chevron-left"></i></a></li>`;
            }
            
            // Номера страниц
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, startPage + 4);
            
            for (let i = startPage; i <= endPage; i++) {
                if (i === currentPage) {
                    html += `<li><span class="page-link active">${i}</span></li>`;
                } else {
                    html += `<li><a href="#" class="page-link" data-page="${i}">${i}</a></li>`;
                }
            }
            
            // Кнопка "Вперед"
            if (currentPage < totalPages) {
                html += `<li><a href="#" class="page-link" data-page="${currentPage + 1}"><i class="fas fa-chevron-right"></i></a></li>`;
            }
            
            html += '</ul>';
            return html;
        }
    </script>
</body>
</html>